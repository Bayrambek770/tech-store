{% load static i18n %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>{% trans "Store" %}</title>
    <link rel="stylesheet" href="{% static 'main/vendors/themify-icons/css/themify-icons.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/meyawo.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/custom.css' %}">
</head>

<body class="store-page has-static-nav">
    <style>
        /* Page-specific spacing (navbar is fixed so provide top offset if needed) */
        .store-page .store-container { margin-top: 12px; }
    </style>
    {% include 'layouts/navbar.html' with static_nav=True %}
    <div class="container store-container page-section-spacer">
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-4">
            <h2 class="mb-2 mb-md-0 mr-md-3">{% trans "Product Store" %}</h2>
            <span class="text-muted">{% trans "Browse & discover" %}</span>
        </div>
        <form method="get" class="store-filters row mb-4" id="filter-form">
        <div class="col-lg-5 mb-2 mb-lg-0"><input type="text" name="q" value="{{ search_query|default:'' }}" class="form-control"
            placeholder="{% trans 'Search products...' %}"></div>
            <div class="col-lg-3 mb-2 mb-lg-0">
                <select name="category" class="form-control">
                    <option value="">{% trans "All Categories" %}</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if current_category == cat.id %}selected{% endif %}>{{ cat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 mb-2 mb-lg-0">
                <select name="page_size" class="form-control" id="page-size-select">
                    {% for size in page_size_options %}
                    <option value="{{ size }}" {% if page_size == size %}selected{% endif %}>{{ size }} {% trans '/ page' %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2"><button class="btn btn-primary btn-block">{% trans "Apply" %}</button></div>
        </form>
        <div id="products-wrapper">
            {% include 'partials/_product_grid.html' %}
            {% include 'partials/_pagination.html' %}
        </div>
    </div>
    <!-- Floating Cart Button -->
    <button id="floating-cart-btn" title="{% trans 'View Cart' %}" style="position:fixed;right:18px;bottom:18px;z-index:1050;"
        class="btn btn-primary btn-lg shadow rounded-circle d-flex align-items-center justify-content-center">
        <i class="ti-shopping-cart"></i>
        <span id="floating-cart-count" class="badge badge-light"
            style="position:absolute;top:-4px;right:-4px;font-size:11px;"></span>
    </button>
    <script>
    // HTML snippet for Advance Payment card to re-add after AJAX filtering
    const ADVANCE_CARD_HTML = `\n<div class="mt-5">\n    <a href="{% url 'donation' %}" class="text-decoration-none d-block p-4 rounded shadow-sm border position-relative advance-card" style="background:linear-gradient(135deg,#f6f9fc,#e9eef5);">\n        <div class="d-flex align-items-center">\n            <div class="mr-4" style="font-size:38px;line-height:1;">ðŸ’³</div>\n            <div>\n                <h4 class="mb-1" style="font-weight:600;">{% filter escapejs %}{% trans 'Making an advance payment' %}{% endfilter %}</h4>\n                <p class="mb-0 text-muted">{% filter escapejs %}{% trans 'Contribute a custom amount and proceed to checkout.' %}{% endfilter %}</p>\n            </div>\n        </div>\n    </a>\n</div>`;
        function updateCartBadge(count) {
            if (count === undefined) { return fetch("{% url 'update_cart_item' %}", { method: 'HEAD' }).catch(() => { }); }
            const badge = document.getElementById('nav-cart-count');
            const floatCount = document.getElementById('floating-cart-count');
            const inlineCount = document.getElementById('cart-inline-count');
            [badge, floatCount, inlineCount].forEach(el => { if (el) el.textContent = count ? count : ''; });
        }
        function bindProductEvents() {
            document.querySelectorAll('#products-wrapper .add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (this.classList.contains('added-once')) {
                        // Toggle: second click acts as quick access to cart instead of incrementing
                        window.location.href = "{% url 'cart' %}";
                        return;
                    }
                    const id = this.getAttribute('data-add');
                    this.disabled = true;
                    fetch("{% url 'add_to_cart' %}", {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                        body: new URLSearchParams({ product_id: id, qty: 1 })
                    }).then(r => r.json()).then(data => { if (data.ok) { updateCartBadge(data.count); this.innerHTML = '<i class="ti-check"></i>'; this.classList.add('added-once','btn-success'); this.classList.remove('btn-outline-primary'); this.title='View in cart'; } })
                    .finally(()=>{ this.disabled = false; });
                });
            });
            document.querySelectorAll('#products-wrapper .page-link-nav').forEach(a => {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    if (!page) return;
                    loadPage(page);
                });
            });
        }
        function serializeFilters(extra) {
            const form = document.getElementById('filter-form');
            const data = new FormData(form);
            if (extra) { Object.entries(extra).forEach(([k, v]) => data.set(k, v)); }
            return new URLSearchParams(data).toString();
        }
        function loadPage(page) {
            const qs = serializeFilters({ page: page });
            fetch(`?${qs}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => { if(!r.ok){ throw new Error('Network response was not ok'); } return r.json(); })
                .then(d => {
                    const wrap = document.getElementById('products-wrapper');
                    wrap.innerHTML = d.html + d.pagination + ADVANCE_CARD_HTML; // ensure advance payment card always at bottom
                    bindProductEvents();
                    window.history.replaceState({}, '', `?${qs}`);
                })
                .catch(err => {
                    console.error('Filter load failed', err);
                    // Optionally show a small alert area
                    const wrap = document.getElementById('products-wrapper');
                    if (wrap) {
                        wrap.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">{% trans 'Failed to load filtered products. Please retry.' %}</div>`);
                    }
                });
        }
        document.getElementById('filter-form').addEventListener('submit', function (e) {
            e.preventDefault();
            loadPage(1);
        });
        document.getElementById('page-size-select').addEventListener('change', function () {
            loadPage(1);
        });
        bindProductEvents();
    document.getElementById('floating-cart-btn').addEventListener('click', () => { window.location.href = "{% url 'cart' %}"; });
        // Ensure advance card present on initial (non-AJAX) render
        (function ensureAdvanceCard(){
            const wrap = document.getElementById('products-wrapper');
            if(wrap && !wrap.querySelector('.advance-card')){
                wrap.insertAdjacentHTML('beforeend', ADVANCE_CARD_HTML);
            }
        })();
    </script>
    <script src="{% static 'main/vendors/jquery/jquery-3.4.1.js' %}"></script>
    <script src="{% static 'main/vendors/bootstrap/bootstrap.bundle.js' %}"></script>
    <script src="{% static 'main/vendors/bootstrap/bootstrap.affix.js' %}"></script>
    <script src="{% static 'main/js/meyawo.js' %}"></script>
    <script src="{% static 'main/js/custom.js' %}"></script>
    <style>
    .store-actions-wrapper{position:relative;}
    .store-actions-inner{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;padding:14px 18px;border:1px solid rgba(0,0,0,.06);border-radius:18px;background:linear-gradient(140deg,rgba(255,255,255,.78),rgba(255,255,255,.55));backdrop-filter:blur(22px) saturate(160%);-webkit-backdrop-filter:blur(22px) saturate(160%);box-shadow:0 4px 28px -10px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.5);} 
    .store-actions-inner .btn{margin-bottom:6px;}
    @media (max-width: 600px){
        .store-actions-inner{flex-direction:column;align-items:stretch;}
        .store-actions-inner .left,.store-actions-inner .right{width:100%;display:flex;justify-content:space-between;}
        #direct-checkout-btn{flex:1;justify-content:center;}
    }
    </style>
</body>

</html>
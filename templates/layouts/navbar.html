{% load static %}
{% load i18n %}
<nav class="site-nav" aria-label="Main navigation">
    <div class="site-nav__bar">
        <a class="site-nav__brand" href="{% url 'home' %}">
            <img class="site-nav__brand-logo" src="{% static 'images/uzcomp2.jpg' %}" alt="{% trans 'All for PC' %}" loading="lazy">
        </a>
        <ul class="site-nav__links site-nav__center" data-desktop-links>
            <li><a href="{% url 'about' %}">{% trans 'About' %}</a></li>
            <li><a href="{% url 'designs:marketplace' %}">{% trans 'Marketplace' %}</a></li>
            <li><a href="{% url 'store' %}">{% trans 'Shop' %}</a></li>
            <li><a href="{% url 'news' %}">{% trans 'News' %}</a></li>
            <li><a href="{% url 'contact' %}">{% trans 'Contact' %}</a></li>
            <li><a href="{% url 'public_offer' %}">{% trans 'Public Offer' %}</a></li>
        </ul>
        <div class="site-nav__links site-nav__actions">
            {% if user.is_superuser %}
                <a class="nav-link d-none d-lg-inline" href="{% url 'orders:dashboard' %}">{% trans 'Dashboard' %}</a>
            {% endif %}
            <a href="{% url 'cart' %}" class="" title="{% trans 'Cart' %}">
                <span class="">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true"><path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
                </span>
                <!-- <span class="cart-label">{% trans 'Cart' %}</span> -->
            </a>
            <div class="lang-switcher">
                {% get_current_language as LANGUAGE_CODE %}
                {% get_available_languages as LANGUAGES %}
                <form action="{% url 'set_language' %}" method="post" class="lang-form glass-lang lang-form-enh" data-default-lang="ru" data-lang-codes="ru,en,uz" aria-label="{% trans 'Change language' %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="language" value="{{ LANGUAGE_CODE }}" class="lang-active-input">
                    <button type="button" class="lang-current-btn" id="langBtnDesktop" aria-haspopup="true" aria-expanded="false" aria-controls="langListDesktop">
                        <span class="lang-label-text">{% for code,name in LANGUAGES %}{% if code == LANGUAGE_CODE %}{{ name }}{% endif %}{% endfor %}</span>
                        <span class="caret" aria-hidden="true">â–¾</span>
                    </button>
                    <ul class="lang-menu" id="langListDesktop" role="menu" hidden>
                        {% for lang_code, lang_name in LANGUAGES %}
                            {% if lang_code != LANGUAGE_CODE %}
                            <li role="none"><button type="button" role="menuitem" class="lang-choice" data-lang="{{ lang_code }}">{{ lang_name }}</button></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </form>
            </div>
        </div>
        <button class="site-nav__toggle" id="navToggle" aria-label="Open menu" aria-expanded="false" aria-controls="offcanvasMenu">
            <span></span><span></span><span></span>
        </button>
    </div>
    <div class="site-nav__offcanvas" id="offcanvasMenu" aria-hidden="true">
        <div class="offcanvas__panel" role="dialog" aria-modal="true" aria-label="Navigation menu">
            <div class="offcanvas__header">
                <a class="site-nav__brand small" href="{% url 'home' %}">{% trans 'All for PC' %}</a>
                <button class="offcanvas__close" id="navClose" aria-label="Close menu">&times;</button>
            </div>
            <ul class="offcanvas__links">
                {% if user.is_superuser %}
                <li><a href="{% url 'orders:dashboard' %}">{% trans 'Dashboard' %}</a></li>
                {% endif %}
                <li><a href="{% url 'about' %}">{% trans 'About' %}</a></li>
                <li><a href="{% url 'designs:marketplace' %}">{% trans 'Marketplace' %}</a></li>
                <li><a href="{% url 'store' %}">{% trans 'Shop' %}</a></li>
                <li><a href="{% url 'news' %}">{% trans 'News' %}</a></li>
                <li><a href="{% url 'contact' %}">{% trans 'Contact' %}</a></li>
                <li><a href="{% url 'public_offer' %}">{% trans 'Public Offer' %}</a></li>
            </ul>
        </div>
    </div>
</nav>
<style>
/* Responsive brand logo that doesn't bloat navbar height */
.site-nav__brand{display:inline-flex;align-items:center;gap:8px;}
.site-nav__brand-logo{display:block;height:40px;width:auto;max-width:100%;border-radius:12px;object-fit:cover;}
@media (min-width: 992px){ /* desktop */
    .site-nav__brand-logo{width:300px;height:60px;border-radius:20px;}
}
/* Layout: brand | center nav | actions */
.site-nav__bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
.site-nav__center{flex:1;display:flex;justify-content:center;gap:25px;align-items:center}
.site-nav__center>li{list-style:none}
.site-nav__center a{padding:8px 12px;display:inline-block;text-align:center;min-width:120px;border-radius:999px}
.site-nav__actions{display:flex;align-items:center;gap:12px}
/* Glass effect language selector */
/* custom minimal dropdown */
@media (min-width: 992px){
    /* Nudge center group slightly left to visually center considering right-side actions */
    .site-nav__center{margin-left:-25px}
}
.lang-form-enh{position:relative;}
.lang-current-btn{display:flex;align-items:center;justify-content:center;gap:6px;background:rgba(255,255,255,0.18);backdrop-filter:blur(14px) saturate(180%);-webkit-backdrop-filter:blur(14px) saturate(180%);border:1px solid rgba(255,255,255,0.35);border-radius:30px;color:#000 !important;font-size:14px;font-weight:600;cursor:pointer;padding:8px 18px;min-height:40px;line-height:1.1;box-shadow:0 4px 12px -4px rgba(0,0,0,.15) inset,0 2px 6px -2px rgba(0,0,0,.15);transition:.25s;} 
.lang-current-btn:hover,.lang-current-btn:focus{border-color:rgba(0,0,0,0.55);background:rgba(255,255,255,0.28);outline:none;}
.lang-current-btn .caret{font-size:11px;transition:transform .25s;}
.lang-current-btn[aria-expanded="true"] .caret{transform:rotate(180deg);} 
.lang-menu{position:absolute;top:110%;right:0;background:#fff;border-radius:14px;padding:8px 8px;list-style:none;margin:6px 0 0;min-width:180px;box-shadow:0 10px 28px -4px rgba(0,0,0,.15),0 4px 10px -2px rgba(0,0,0,.12);z-index:1000;}
.lang-menu li{margin:0;padding:0;}
.lang-choice{width:100%;text-align:left;background:transparent;border:none;padding:10px 12px;border-radius:10px;font-size:14px;cursor:pointer;color:#222;display:flex;align-items:center;justify-content:space-between;transition:.18s;} 
.lang-choice:hover,.lang-choice:focus{background:#f2f2f2;outline:none;} 
@media (prefers-color-scheme:dark){.lang-current-btn{color:#000 !important;border-color:rgba(255,255,255,0.28);} .lang-menu{background:#695c5c;color:#eee;} .lang-choice{color:#eee;} .lang-choice:hover{background:#2a2a2a;}}
@media (prefers-color-scheme:dark){.glass-lang .lang-select-wrapper{background:rgba(255,255,255,0.10);border-color:rgba(255,255,255,0.25);} .glass-lang .lang-select{color:#f3f3f3;} }
.glass-lang .lang-select:focus{outline:none;}
/* remove custom caret span; rely on native arrow */
.glass-lang .lang-select:focus + .lang-caret{transform:rotate(180deg);} 
/* Cart as pill-style button consistent with center items (responsive) */
.site-nav__btn{display:inline-flex;align-items:center;gap:8px;border-radius:999px;text-decoration:none;padding:clamp(6px,0.9vw,10px) clamp(10px,1.2vw,16px);font-size:clamp(12px,1.05vw,14px);min-height:clamp(34px,4.2vw,40px);justify-content:center}
.site-nav__btn:hover{text-decoration:none}
@media (min-width: 992px){ .site-nav__btn{min-width:clamp(110px,12vw,150px)} }
/* Ensure offcanvas toggles are visible when opened */
.site-nav__offcanvas[aria-hidden="true"]{display:none}
.site-nav__offcanvas[aria-hidden="false"]{display:block !important}
body.nav-open{overflow:hidden}
/* Offcanvas base styles */
.site-nav__offcanvas{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999;opacity:0;pointer-events:none;transition:opacity .28s cubic-bezier(0.22, 0.61, 0.36, 1);will-change: opacity}
.site-nav__offcanvas[aria-hidden="false"]{opacity:1;pointer-events:auto}
.offcanvas__panel{position:absolute;top:0;right:0;height:100%;width:min(86vw,360px);max-width:100%;background:#fff;box-shadow:-6px 0 16px rgba(0,0,0,.15);padding:16px;overflow:auto;transform:translateX(100%);transition:transform .32s cubic-bezier(0.22, 0.61, 0.36, 1);will-change: transform}
.site-nav__offcanvas[aria-hidden="false"] .offcanvas__panel{transform:translateX(0);transition-delay:.06s}
.offcanvas__header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.offcanvas__close{background:transparent;border:none;font-size:28px;line-height:1;cursor:pointer}
</style>
<script>
// Simple auto-submit select with URL language prefix logic
document.addEventListener('DOMContentLoaded', function(){
    const defaultLang = 'ru';
    function stripLeadingLang(path, codes){
        const parts = path.split('/').filter(p=>p.length>0);
        if(parts.length && codes.includes(parts[0])) parts.shift();
        return '/' + parts.join('/') + (path.endsWith('/') && parts.length? '/':'');
    }
    function buildNext(target, codes){
        const loc = window.location; const base = stripLeadingLang(loc.pathname, codes); const q=loc.search||''; const h=loc.hash||'';
        if(target===defaultLang) return base+q+h; return '/' + target + (base==='/'?'':base) + q + h;
    }
    document.querySelectorAll('.lang-form-enh').forEach(form=>{
        const btn = form.querySelector('.lang-current-btn');
        const menu = form.querySelector('.lang-menu');
        const activeInput = form.querySelector('.lang-active-input');
        const codes = (form.dataset.langCodes||'').split(',').filter(Boolean);
        if(!btn || !menu || !activeInput) return;
        let open=false;
        function openMenu(){ if(open) return; open=true; menu.hidden=false; btn.setAttribute('aria-expanded','true'); document.addEventListener('mousedown', outside); document.addEventListener('keydown', keyHandler); positionMenu(); }
        function closeMenu(focus=true){ if(!open) return; open=false; menu.hidden=true; btn.setAttribute('aria-expanded','false'); document.removeEventListener('mousedown', outside); document.removeEventListener('keydown', keyHandler); if(focus) btn.focus(); }
        function outside(e){ if(!form.contains(e.target)) closeMenu(false); }
        function keyHandler(e){ if(e.key==='Escape'){ closeMenu(); } }
        function positionMenu(){ /* could adjust if near edge */ }
        btn.addEventListener('click', ()=> open? closeMenu(): openMenu());
        menu.querySelectorAll('.lang-choice').forEach(choice=>{
            choice.addEventListener('click', ()=>{
                const code = choice.dataset.lang;
                if(!code) return;
                const nextInp = form.querySelector('input[name="next"]');
                if(nextInp) nextInp.value = buildNext(code, codes);
                activeInput.value = code;
                form.submit();
            });
        });
    });
    // Offcanvas (hamburger) toggle
    const navToggle = document.getElementById('navToggle');
    const offcanvas = document.getElementById('offcanvasMenu');
    const navClose = document.getElementById('navClose');
    if(navToggle && offcanvas){
        const panel = offcanvas.querySelector('.offcanvas__panel');
        const openCanvas = ()=>{
            // Stage 1: ensure element participates in layout
            offcanvas.style.display = 'block';
            offcanvas.setAttribute('aria-hidden','true');
            // Stage 2: next frame, toggle to visible to trigger CSS transitions
            requestAnimationFrame(()=>{
                // force reflow to ensure transition triggers reliably
                void offcanvas.offsetWidth;
                offcanvas.setAttribute('aria-hidden','false');
                document.body.classList.add('nav-open');
                navToggle.setAttribute('aria-expanded','true');
            });
                // Initialize cart count from server
                fetch('{% url "cart_count" %}', {headers:{'X-Requested-With':'XMLHttpRequest'}})
                    .then(r=>r.ok?r.json():null).then(d=>{
                        if(!d) return; const n = document.getElementById('nav-cart-count'); const m=document.getElementById('nav-cart-count-mobile');
                        if(n) n.textContent = d.count ? d.count : '';
                        if(m) m.textContent = d.count ? d.count : '';
                    }).catch(()=>{});
        };
        const closeCanvas = ()=>{
            offcanvas.setAttribute('aria-hidden','true');
            document.body.classList.remove('nav-open');
            navToggle.setAttribute('aria-expanded','false');
            const finalize = ()=>{ offcanvas.style.display = ''; cleanup(); };
            let done = false;
            const onEnd = (e)=>{
                if(done) return; if(!panel) return;
                if(e.target === panel && e.propertyName === 'transform'){
                    done = true; finalize();
                }
            };
            const cleanup = ()=>{ if(panel) panel.removeEventListener('transitionend', onEnd); };
            if(panel) panel.addEventListener('transitionend', onEnd);
            // Fallback timeout in case transitionend isn't fired
            setTimeout(()=>{ if(!done) finalize(); }, 450);
        };
        navToggle.addEventListener('click', ()=>{
            const hidden = offcanvas.getAttribute('aria-hidden') !== 'false';
            if(hidden) openCanvas(); else closeCanvas();
        });
        if(navClose) navClose.addEventListener('click', closeCanvas);
        offcanvas.addEventListener('click', (e)=>{ if(e.target === offcanvas) closeCanvas(); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeCanvas(); });
        offcanvas.querySelectorAll('a').forEach(a=> a.addEventListener('click', closeCanvas));
    }
});
</script>

{% load static i18n currency %}
<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{% trans "Checkout" %}</title>
<link rel="stylesheet" href="{% static 'main/css/meyawo.css' %}">
<link rel="stylesheet" href="{% static 'main/css/custom.css' %}">
<style>.checkout-container{margin-top:16px;}</style>
</head><body>
{% include 'layouts/navbar.html' with static_nav=True %}
        <div class="container checkout-container page-section-spacer" style="max-width:880px; padding: 20px; margin-top:130px">
               
    <form id="checkout-form" class="row" method="post" action="{% url 'orders:create' %}" novalidate>
            {% csrf_token %}
            <div class="col-md-7 pr-md-5">
            <h5 class="mb-3">{% trans "Shipping & Contact" %}</h5>
            <div class="form-row">
              <div class="form-group col-sm-6">
                  <label for="first_name">{% trans "First Name" %}</label>
                  <input
                  type="text"
                  id="first_name"
                  name="first_name"
                  class="form-control"
                  required
                  minlength="2"
                  maxlength="40"
                  pattern="^[A-Za-zÀ-ÖØ-öø-ÿ' -]{2,40}$"
                  autocomplete="given-name"
                  placeholder="{% trans 'John' %}"
                  oninvalid="this.setCustomValidity('Enter 2-40 letters (letters, spaces, apostrophes, hyphens)')"
                  oninput="this.setCustomValidity('')">
              </div>
              <div class="form-group col-sm-6">
                  <label for="last_name">{% trans "Last Name" %}</label>
                  <input
                  type="text"
                  id="last_name"
                  name="last_name"
                  class="form-control"
                  required
                  minlength="2"
                  maxlength="60"
                  pattern="^[A-Za-zÀ-ÖØ-öø-ÿ' -]{2,60}$"
                  autocomplete="family-name"
                  placeholder="{% trans 'Doe' %}"
                  oninvalid="this.setCustomValidity('Enter 2-60 letters (letters, spaces, apostrophes, hyphens)')"
                  oninput="this.setCustomValidity('')">
              </div>
            </div>
            <div class="form-group">
                <label for="email">{% trans "Email" %}</label>
                <input
                type="email"
                id="email"
                name="email"
                class="form-control"
                required
                maxlength="100"
                autocomplete="email"
                placeholder="{% trans 'you@example.com' %}"
                pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
                oninvalid="this.setCustomValidity('Enter a valid email like name@example.com')"
                oninput="this.setCustomValidity('')">
            </div>
            <div class="form-group">
                <label for="phone">{% trans "Phone" %}</label>
                <input
                type="tel"
                id="phone"
                name="phone"
                class="form-control"
                required
                minlength="7"
                maxlength="20"
                autocomplete="tel"
                placeholder="{% trans '+1 555 123 4567' %}"
                pattern="^[+]?[\d ()\-]{7,20}$"
                oninvalid="this.setCustomValidity('Enter a valid phone number (7-20 digits, spaces, (), - allowed)')"
                oninput="this.setCustomValidity('')">
            </div>
            <div class="form-group">
                <label for="address1">{% trans "Address Line 1" %}</label>
                <input
                type="text"
                id="address1"
                name="address1"
                class="form-control"
                required
                minlength="5"
                maxlength="120"
                autocomplete="address-line1"
                placeholder="{% trans '123 Main St' %}"
                oninvalid="this.setCustomValidity('Enter your street address (min 5 chars)')"
                oninput="this.setCustomValidity('')">
            </div>
            <div class="form-group">
                <label for="address2">{% trans "Address Line 2" %} <span class="text-muted small">({% trans 'Optional' %})</span></label>
                <input
                type="text"
                id="address2"
                name="address2"
                class="form-control"
                minlength="0"
                maxlength="120"
                autocomplete="address-line2"
                placeholder="Apt, suite, etc. (optional)">
            </div>
            <div class="form-row">
                <div class="form-group col-md-5">
                <label for="country">{% trans "Country" %}</label>
                <input
                    type="text"
                    id="country"
                    name="country"
                    class="form-control"
                    required
                    minlength="2"
                    maxlength="56"
                    autocomplete="country-name"
                    pattern="^[A-Za-zÀ-ÖØ-öø-ÿ' .-]{2,56}$"
                    placeholder="{% trans 'Country' %}"
                    oninvalid="this.setCustomValidity('Enter country name (letters & spaces)')"
                    oninput="this.setCustomValidity('')">
                </div>
                <div class="form-group col-md-4">
                <label for="state">{% trans "State/Region" %}</label>
                <input
                    type="text"
                    id="state"
                    name="state"
                    class="form-control"
                    required
                    minlength="2"
                    maxlength="40"
                    autocomplete="address-level1"
                    pattern="^[A-Za-zÀ-ÖØ-öø-ÿ0-9' .-]{2,40}$"
                    placeholder="{% trans 'State / Region' %}"
                    oninvalid="this.setCustomValidity('Enter state/region (2-40 chars)')"
                    oninput="this.setCustomValidity('')">
                </div>
                <div class="form-group col-md-3">
                <label for="zip">{% trans "ZIP" %}</label>
                <input
                    type="text"
                    id="zip"
                    name="zip"
                    class="form-control"
                    required
                    minlength="3"
                    maxlength="12"
                    autocomplete="postal-code"
                    pattern="^[A-Za-z0-9\- ]{3,12}$"
                    placeholder="{% trans 'ZIP' %}"
                    oninvalid="this.setCustomValidity('3-12 chars: letters, numbers, space or dash')"
                    oninput="this.setCustomValidity('')">
                </div>
            </div>
            <hr class="my-4">
            <h5 class="mb-3">{% trans "Payment" %}</h5>
            <div class="form-group mb-2">
                <div class="custom-control custom-radio mb-1">
                <input type="radio" id="pay_card" name="payment_method" class="custom-control-input" value="card" checked>
                <label class="custom-control-label" for="pay_card">{% trans "Credit / Debit Card" %}</label>
                </div>
                <div class="custom-control custom-radio">
                <input type="radio" id="pay_cod" name="payment_method" value="cod" class="custom-control-input">
                <label class="custom-control-label" for="pay_cod">{% trans "Cash on Delivery" %}</label>
                </div>
            </div>
            <div id="card-fields" class="border rounded p-3 bg-light mb-3">
                <div class="form-group mb-2">
                <label for="card_number" class="small mb-1">{% trans "Card Number" %}</label>
                <input
                    type="text"
                    id="card_number"
                    name="card_number"
                    inputmode="numeric"
                    autocomplete="cc-number"
                    class="form-control"
                    maxlength="19"
                    placeholder="{% trans '4111 1111 1111 1111' %}"
                    pattern="^(\d{4} ?){3}\d{4}$"
                    data-strip="true"
                    required
                    oninvalid="this.setCustomValidity('Enter 16 digit card number')"
                    oninput="this.setCustomValidity('')">
                </div>
                <div class="form-row">
                <div class="form-group col-6 mb-2">
                    <label for="card_exp" class="small mb-1">{% trans "Expiry (MM/YY)" %}</label>
                    <input
                    type="text"
                    id="card_exp"
                    name="card_exp"
                    inputmode="numeric"
                    autocomplete="cc-exp"
                    class="form-control"
                    maxlength="5"
                    placeholder="{% trans '08/27' %}"
                    pattern="^(0[1-9]|1[0-2])\/\d{2}$"
                    required
                    oninvalid="this.setCustomValidity('Format MM/YY, month 01-12')"
                    oninput="this.setCustomValidity('')">
                </div>
                <div class="form-group col-6 mb-2">
                    <label for="card_cvc" class="small mb-1">{% trans "CVC" %}</label>
                    <input
                    type="text"
                    id="card_cvc"
                    name="card_cvc"
                    inputmode="numeric"
                    autocomplete="cc-csc"
                    class="form-control"
                    maxlength="4"
                    placeholder="{% trans '123' %}"
                    pattern="^\d{3,4}$"
                    required
                    oninvalid="this.setCustomValidity('CVC 3 or 4 digits')"
                    oninput="this.setCustomValidity('')">
                </div>
                </div>
                <div class="d-flex align-items-center small text-muted"><i class="ti-lock mr-1"></i> {% trans "Your card data is secured." %}</div>
            </div>
            </div>
            <div class="col-md-5">
            <h5 class="mb-3">{% trans "Order Summary" %}</h5>
            <ul id="order-summary" class="list-unstyled small">
                {% for item in items %}
                                <li class="media mb-2">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" class="mr-2 rounded" style="width:40px;height:40px;object-fit:cover;" alt="{{ item.product.name }}">
                                        {% elif item.product.cover_image %}
                                            <img src="{{ item.product.cover_image.url }}" class="mr-2 rounded" style="width:40px;height:40px;object-fit:cover;" alt="{{ item.product.name }}">
                                        {% else %}
                                            <img src="{% static 'images/placeholder.png' %}" class="mr-2 rounded" style="width:40px;height:40px;object-fit:cover;" alt="{{ item.product.name }}">
                                        {% endif %}
            <div class="media-body">{{ item.product.name }} <span class="text-muted">x {{ item.qty }}</span><div>{{ item.line_total|price_local }}</div></div>
                </li>
                {% endfor %}
            </ul>
        <p class="font-weight-bold d-flex justify-content-between align-items-center">{% trans "Total:" %} <span class="h5 mb-0"><span id="order-total">{{ total|price_local }}</span></span></p>
            <button type="submit" id="pay-btn" class="btn btn-gradient btn-block" disabled>{% trans "Pay Now" %}</button>
            <div id="form-errors" class="text-danger small mt-2" style="display:none;"></div>
            </div>
        </form>
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-4">{{ message }}</div>
        {% endfor %}
    </div>
<script src="{% static 'main/vendors/jquery/jquery-3.4.1.js' %}"></script>
<script src="{% static 'main/vendors/bootstrap/bootstrap.bundle.js' %}"></script>
<script src="{% static 'main/vendors/bootstrap/bootstrap.affix.js' %}"></script>
<script src="{% static 'main/js/meyawo.js' %}"></script>
<script src="{% static 'main/js/custom.js' %}"></script>
<script>
// Simple client-side validation & formatting
(function(){
    const form = document.getElementById('checkout-form');
    const payBtn = document.getElementById('pay-btn');
    const cardSection = document.getElementById('card-fields');
    const errorsBox = document.getElementById('form-errors');
    const methodRadios = document.querySelectorAll('input[name="payment_method"]');
    const requiredSelectors = ['#first_name','#last_name','#email','#phone','#address1','#country','#state','#zip'];
    const cardSelectors = ['#card_number','#card_exp','#card_cvc'];

    function digitsOnly(v){return v.replace(/\D+/g,'');}
    function formatCard(num){ return digitsOnly(num).slice(0,16).replace(/(.{4})/g,'$1 ').trim(); }
    function formatExp(v){ const d=digitsOnly(v).slice(0,4); if(d.length<3) return d; return d.slice(0,2)+'/'+d.slice(2); }

    const cardNumber = document.getElementById('card_number');
    const cardExp = document.getElementById('card_exp');
    const cardCvc = document.getElementById('card_cvc');

    cardNumber.addEventListener('input', e=>{ e.target.value = formatCard(e.target.value); validate(); });
    cardExp.addEventListener('input', e=>{ e.target.value = formatExp(e.target.value); validate(); });
    cardCvc.addEventListener('input', e=>{ e.target.value = digitsOnly(e.target.value).slice(0,4); validate(); });
    methodRadios.forEach(r=> r.addEventListener('change', ()=>{ togglePaymentFields(); validate(); }));
    form.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', ()=> validate()));

    function togglePaymentFields(){
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        if(method==='card'){
            cardSection.style.display='block';
            cardSelectors.forEach(sel=> form.querySelector(sel).setAttribute('required','required'));
        } else {
            cardSection.style.display='none';
            cardSelectors.forEach(sel=> form.querySelector(sel).removeAttribute('required'));
        }
    }
    function validEmail(v){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v); }
    function validate(){
        let errs=[];
        requiredSelectors.forEach(sel=>{ const el=form.querySelector(sel); if(el && !el.value.trim()) errs.push(sel+' required'); });
        const email = form.querySelector('#email'); if(email && !validEmail(email.value)) errs.push('Invalid email');
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        if(method==='card'){
            const rawCard = digitsOnly(cardNumber.value); if(rawCard.length!==16) errs.push('Card number must be 16 digits');
            const exp = cardExp.value; if(!/^\d{2}\/\d{2}$/.test(exp)) errs.push('Expiry format MM/YY'); else { const mm=parseInt(exp.slice(0,2),10); if(mm<1||mm>12) errs.push('Expiry month 01-12'); }
            const cvc = digitsOnly(cardCvc.value); if(cvc.length<3||cvc.length>4) errs.push('CVC 3-4 digits');
        }
        if(errs.length){
            payBtn.disabled=true; errorsBox.style.display='block'; errorsBox.textContent=errs[0];
        } else {
            errorsBox.style.display='none'; errorsBox.textContent=''; payBtn.disabled=false; }
    }
    togglePaymentFields();
    validate();
})();
</script>
</body></html>

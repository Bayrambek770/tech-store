{% extends 'layouts/base.html' %}
{% load static i18n currency %}
{% block title %}{% trans 'Cart' %}{% endblock %}
{% block content %}
    <style>.cart-container{margin-top:16px;}</style>
    <div class="container cart-container page-section-spacer">
    <h2 class="mb-1">{% trans "Shopping Cart" %}</h2>
    <p class="muted-link mb-4">{% trans "Review your selected items" %}</p>
        <table class="cart-table table table-striped">
            <thead class="thead-light">
                <tr>
                    <th style="width:90px;">{% trans "Image" %}</th>
                    <th>{% trans "Product" %}</th>
                    <th>{% trans "Price" %}</th>
                    <th style="width:140px;">{% trans "Quantity" %}</th>
                    <th>{% trans "Total" %}</th>
                    <th>{% trans "Remove" %}</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                {% for item in items %}
                <tr data-id="{{ item.key }}">
                    <td>{% if item.is_donation %}<div class="d-flex align-items-center justify-content-center bg-light text-muted rounded" style="height:60px;width:60px;font-size:11px;">{% trans "No Img" %}</div>{% elif item.product.image %}<img src="{{ item.product.image.url }}" class="img-fluid rounded" style="max-height:60px;object-fit:cover;">{% else %}<img src="{% static 'images/placeholder.png' %}" class="img-fluid rounded" style="max-height:60px;object-fit:cover;">{% endif %}</td>
                    <td>{{ item.product.name }} {% if item.is_design %}<span class="badge badge-info ml-1">{% trans "Design" %}</span>{% endif %}{% if item.is_donation %} <span class="badge badge-warning ml-1">{% trans "Advance" %}</span>{% endif %}</td>
                    <td data-price-usd="{{ item.product.price }}">{{ item.product.price|price_local }}</td>
                    <td class="align-middle">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend"><button class="btn btn-outline-secondary btn-qty"
                                    data-action="dec">-</button></div>
                            <input type="text" class="form-control text-center" value="{{ item.qty }}" readonly
                                style="max-width:48px;">
                            <div class="input-group-append"><button class="btn btn-outline-secondary btn-qty"
                                    data-action="inc">+</button></div>
                        </div>
                    </td>
                    <td class="line-total" data-line-usd="{{ item.line_total }}">{{ item.line_total|price_local }}</td>
                    <td><button class="btn btn-sm btn-outline-danger cart-remove-btn" data-action="remove" aria-label="Remove item"><span aria-hidden="true">&times;</span></button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">{% trans "Your cart is empty." %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="cart-summary text-right">
            <p><strong>{% trans "Subtotal:" %}</strong> <span id="cart-subtotal" data-subtotal-usd="{{ subtotal }}">{{ subtotal|price_local }}</span></p>
            <a href="{% url 'store' %}" class="btn btn-outline-primary mr-2"><i class="ti-angle-left"></i> {% trans "Continue Shopping" %}</a>
            {% if items %}<a href="{% url 'checkout' %}" class="btn btn-gradient">{% trans "Proceed to Checkout" %}</a>{% endif %}
        </div>
    </div>
    <script>
        const csrftoken = '{{ csrf_token }}';
        function post(url, data) {
            return fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            }).then(async r => {
                let js;
                try { js = await r.json(); } catch(e){ return { ok:false, parse_error:true, status:r.status }; }
                js.status = r.status;
                return js;
            }).catch(err => ({ ok:false, network_error:true, err: String(err) }));
        }
        function formatLocal(amount){
            const lang = document.documentElement.lang || 'en';
            const meta = { en:{sym:'$', suf:false, dec:'.'}, ru:{sym:'â‚½', suf:true, dec:','}, uz:{sym:"so'm", suf:true, dec:','} }[lang.slice(0,2)] || {sym:'$', suf:false, dec:'.'};
            const val = Number(amount)||0;
            const fixed = val.toFixed(2);
            const parts = fixed.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
            const num = parts[0] + (meta.dec === ',' ? ',' : '.') + parts[1];
            return meta.suf ? `${num} ${meta.sym}` : `${meta.sym}${num}`;
        }
        function updateBadges(count) { const badge = document.getElementById('nav-cart-count'); if (badge) badge.textContent = count ? count : ''; }
        document.getElementById('cart-body').addEventListener('click', e => {
            const btn = e.target.closest('button'); if (!btn) return;
            const tr = btn.closest('tr'); const id = tr.getAttribute('data-id'); const action = btn.getAttribute('data-action');
            post('{% url 'update_cart_item' %}', { product_id: id, action }).then(data => {
                if (!data.ok) {
                    console.error('Cart update failed', data);
                    return;
                }
                updateBadges(data.count);
                if (data.removed) { tr.remove(); }
                else {
                    tr.querySelector('input').value = data.qty;
                    const lineCell = tr.querySelector('.line-total');
                    lineCell.dataset.lineUsd = data.line_total;
                    lineCell.textContent = formatLocal(data.line_total);
                }
                const subtotalEl = document.getElementById('cart-subtotal');
                subtotalEl.dataset.subtotalUsd = data.subtotal;
                subtotalEl.textContent = formatLocal(data.subtotal);
                // If cart empty add empty row
                if (data.count === 0) {
                    const body = document.getElementById('cart-body');
                    if (!body.querySelector('.empty-row')) { body.innerHTML = '<tr class="empty-row"><td colspan="6" class="text-center">{% filter escapejs %}{% trans "Your cart is empty." %}{% endfilter %}</td></tr>'; }
                    document.querySelector('.cart-summary a.btn-gradient')?.remove();
                }
            });
        });
    </script>
{% endblock %}
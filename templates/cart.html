{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="{% static 'main/css/meyawo.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/custom.css' %}">
</head>

<body>
    <style>.cart-container{margin-top:16px;}</style>
    {% include 'layouts/navbar.html' with static_nav=True %}
    <div class="container cart-container page-section-spacer">
        <h2 class="mb-1">Shopping Cart</h2>
        <p class="muted-link mb-4">Review your selected items</p>
        <table class="cart-table table table-striped">
            <thead class="thead-light">
                <tr>
                    <th style="width:90px;">Image</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th style="width:140px;">Quantity</th>
                    <th>Total</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                {% for item in items %}
                <tr data-id="{{ item.key }}">
                    <td>{% if item.is_donation %}<div class="d-flex align-items-center justify-content-center bg-light text-muted rounded" style="height:60px;width:60px;font-size:11px;">No Img</div>{% elif item.product.image %}<img src="{{ item.product.image.url }}" class="img-fluid rounded" style="max-height:60px;object-fit:cover;">{% else %}<img src="{% static 'images/placeholder.png' %}" class="img-fluid rounded" style="max-height:60px;object-fit:cover;">{% endif %}</td>
                    <td>{{ item.product.name }} {% if item.is_design %}<span class="badge badge-info ml-1">Design</span>{% endif %}{% if item.is_donation %} <span class="badge badge-warning ml-1">Advance</span>{% endif %}</td>
                    <td>${{ item.product.price }}</td>
                    <td class="align-middle">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend"><button class="btn btn-outline-secondary btn-qty"
                                    data-action="dec">-</button></div>
                            <input type="text" class="form-control text-center" value="{{ item.qty }}" readonly
                                style="max-width:48px;">
                            <div class="input-group-append"><button class="btn btn-outline-secondary btn-qty"
                                    data-action="inc">+</button></div>
                        </div>
                    </td>
                    <td class="line-total">${{ item.line_total }}</td>
                    <td><button class="btn btn-sm btn-outline-danger cart-remove-btn" data-action="remove" aria-label="Remove item"><span aria-hidden="true">&times;</span></button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">Your cart is empty.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="cart-summary text-right">
            <p><strong>Subtotal:</strong> $<span id="cart-subtotal">{{ subtotal }}</span></p>
            <a href="{% url 'store' %}" class="btn btn-outline-primary mr-2"><i class="ti-angle-left"></i> Continue
                Shopping</a>
            {% if items %}<a href="{% url 'checkout' %}" class="btn btn-gradient">Proceed to Checkout</a>{% endif %}
        </div>
    </div>
    <script>
        const csrftoken = '{{ csrf_token }}';
        function post(url, data) { return fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams(data) }).then(r => r.json()); }
        function updateBadges(count) { const badge = document.getElementById('nav-cart-count'); if (badge) badge.textContent = count ? count : ''; }
        document.getElementById('cart-body').addEventListener('click', e => {
            const btn = e.target.closest('button'); if (!btn) return;
            const tr = btn.closest('tr'); const id = tr.getAttribute('data-id'); const action = btn.getAttribute('data-action');
            post('{% url 'update_cart_item' %}', { product_id: id, action }).then(data => {
                if (!data.ok) return;
                updateBadges(data.count);
                if (data.removed) { tr.remove(); }
                else { tr.querySelector('input').value = data.qty; tr.querySelector('.line-total').textContent = '$' + data.line_total.toFixed(2); }
                document.getElementById('cart-subtotal').textContent = data.subtotal.toFixed(2);
                // If cart empty add empty row
                if (data.count === 0) {
                    const body = document.getElementById('cart-body');
                    if (!body.querySelector('.empty-row')) { body.innerHTML = '<tr class="empty-row"><td colspan="6" class="text-center">Your cart is empty.</td></tr>'; }
                    document.querySelector('.cart-summary a.btn-gradient')?.remove();
                }
            });
        });
    </script>
    <script src="{% static 'main/vendors/jquery/jquery-3.4.1.js' %}"></script>
    <script src="{% static 'main/vendors/bootstrap/bootstrap.bundle.js' %}"></script>
    <script src="{% static 'main/vendors/bootstrap/bootstrap.affix.js' %}"></script>
    <script src="{% static 'main/js/meyawo.js' %}"></script>
    <script src="{% static 'main/js/custom.js' %}"></script>
</body>

</html>